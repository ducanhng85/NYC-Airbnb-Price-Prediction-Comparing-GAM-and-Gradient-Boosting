---
title: "Final Project"
author: "Duc Nguyen"
date: "2025-04-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load dataset

```{r}
data <- read.csv("/Users/bebexmimi/Downloads/archive (1)/AB_NYC_2019.csv")
head(data)
```

```{r}
summary(data)
```

## Data preparation

```{r}
library(dplyr)
```

```{r}
data <- data %>% select(-id, -host_name, -last_review,-name)
```

```{r}
colSums(is.na(data))
```

```{r}
data$reviews_per_month[is.na(data$reviews_per_month)] <- mean(data$reviews_per_month, na.rm = TRUE)

```

```{r}
colSums(is.na(data))
```

```{r}
library(corrplot)
```

```{R}
num_data <- data %>% select_if(is.numeric)

cor_matrix <- cor(num_data)
corrplot(cor_matrix, method = "color", tl.col = "black")
```


```{r}
library(ggplot2)
```

```{r}
ggplot(data, aes(x=price)) + 
    geom_histogram(bins = 30, fill = "blue") + 
    ggtitle("The raw distribution of prices") + labs(x="Price")
```

```{r}
data$log_price <- log(data$price+1)
```

```{r}
data <- data %>%
  select(-price)
```


```{r}
ggplot(data, aes(x=log_price)) + 
    geom_histogram(bins = 30, fill = "blue") +
    ggtitle("The raw distribution of prices") + labs(x="Price")
```
```{r}
library(dplyr)
library(leaflet)

# Select relevant columns including pre-computed log_price
to_leaflet_pre <- data %>%
  select(longitude, latitude, neighbourhood_group, neighbourhood, room_type, log_price)

# Cap log_price for visualization purposes
to_leaflet_pre$log_price[to_leaflet_pre$log_price <= 3] <- 3
to_leaflet_pre$log_price[to_leaflet_pre$log_price >= 7] <- 7

# Center of map
center_lon <- median(to_leaflet_pre$longitude, na.rm = TRUE)
center_lat <- median(to_leaflet_pre$latitude, na.rm = TRUE)

# Color palette for log_price
pal <- colorNumeric(
  palette = colorRampPalette(c('red', 'yellow', 'green'))(length(to_leaflet_pre$log_price)),
  domain = to_leaflet_pre$log_price
)

# Create interactive map
leaflet(data = to_leaflet_pre) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~longitude,
    lat = ~latitude,
    popup = ~paste0(
      "<strong>Region:</strong> ", neighbourhood_group, ", ", neighbourhood, "<br>",
      "<strong>Room type:</strong> ", room_type, "<br>",
      "<strong>Log price:</strong> ", round(log_price, 2), "<br>"
    ),
    color = ~pal(log_price),
    radius = 5,
    fillOpacity = 0.7,
    stroke = FALSE,
    clusterOptions = markerClusterOptions()
  ) %>%
  setView(lng = center_lon, lat = center_lat, zoom = 10) %>%
  addLegend(
    position = "topleft",
    pal = pal,
    values = ~log_price,
    title = "Log Prices of Airbnb Listings",
    opacity = 1
  )  

```

### Model Discussion

#### GAMs
```{r}
library(gam)
```


```{r}
library(caret)

```

```{r}
set.seed(123)
train_index <- createDataPartition(data$log_price, p = 0.8, list = FALSE)

train_data <- data[train_index, ]
test_data <- data[-train_index, ]
```

```{r}
library(mgcv)
library(rsample)  
library(Metrics) 
library(purrr)    


aic_values <- c()
bic_values <- c()
adj_r2_values <- c()
rmse_values <- c()

set.seed(123) 
folds <- vfold_cv(data, v = 5)  

cv_results <- map_dfr(folds$splits, function(split) {
  train_split <- analysis(split)
  val_split <- assessment(split)
  
  gam_model <- gam(
    log_price ~ s(latitude) + s(longitude) + s(minimum_nights) +
      s(number_of_reviews) + s(reviews_per_month) +
      s(calculated_host_listings_count) + s(availability_365) +
      neighbourhood_group + room_type,
    data = train_split
  )
  
  preds <- predict(gam_model, newdata = val_split)
  
  rmse_error <- rmse(val_split$log_price, preds)
  
  gam_summary <- summary(gam_model)
  aic_value <- AIC(gam_model)
  bic_value <- BIC(gam_model)
  adj_r2_value <- gam_summary$r.sq 
  
  aic_values <<- c(aic_values, aic_value)
  bic_values <<- c(bic_values, bic_value)
  adj_r2_values <<- c(adj_r2_values, adj_r2_value)
  rmse_values <<- c(rmse_values, rmse_error)
  
  data.frame(
    AIC = aic_value,
    BIC = bic_value,
    Adj_R2 = adj_r2_value,
    RMSE = rmse_error
  )
})

cat("Average AIC:", mean(aic_values), "\n")
cat("Average BIC:", mean(bic_values), "\n")
cat("Average Adjusted R²:", mean(adj_r2_values), "\n")
cat("Average RMSE:", mean(rmse_values), "\n")

```
```{r}
summary(gam_model)
```


#### Boosting

```{r}
library(gbm)

```


```{R}
set.seed(123)
control <- trainControl(method = "cv", number = 5)
gbm_model <- train(
  log_price ~ latitude + longitude + minimum_nights + number_of_reviews +
    reviews_per_month + calculated_host_listings_count + availability_365 +
    neighbourhood_group + room_type,
  data = train_data,
  method = "gbm",
  trControl = control,
  tuneLength = 5,
  verbose = FALSE
)

print(gbm_model)

```

```{R}
summary(gbm_model)
```

```{r}
par(mfrow = c(1, 2))
plot(gbm_model$finalModel, i = "longitude", main = "Partial Dependence: longitude")
```

```{r}
par(mfrow = c(1, 2))
plot(gbm_model$finalModel, i = "latitude", main = "Partial Dependence: latitude")
```

```{r}
train_preds <- predict(gbm_model, newdata = train_data)
test_preds <- predict(gbm_model, newdata = test_data)
# RMSE
rmse_train <- sqrt(mean((train_data$log_price - train_preds)^2))
rmse_test <- sqrt(mean((test_data$log_price - test_preds)^2))
# R²
r2_train <- 1 - sum((train_data$log_price - train_preds)^2) / sum((train_data$log_price - mean(train_data$log_price))^2)
r2_test <- 1 - sum((test_data$log_price - test_preds)^2) / sum((test_data$log_price - mean(test_data$log_price))^2)

# Number of predictors (excluding intercept)
p <- length(gbm_model$finalModel$var.names)

# Sample sizes
n_train <- nrow(train_data)
n_test <- nrow(test_data)

# Adjusted R²
adj_r2_train <- 1 - ((1 - r2_train) * (n_train - 1)) / (n_train - p - 1)
adj_r2_test <- 1 - ((1 - r2_test) * (n_test - 1)) / (n_test - p - 1)
cat("Train RMSE:", rmse_train, "\n")
cat("Test RMSE:", rmse_test, "\n")
cat("Train Adjusted R²:", adj_r2_train, "\n")
cat("Test Adjusted R²:", adj_r2_test, "\n")

```
